---
title: Руководство по Развертывание приложения Django с PostgreSQL с помощью портала Azure
description: Узнайте, как подготовить веб-приложение и базу данных PostgreSQL в Azure, а также развернуть код приложения из GitHub.
ms.devlang: python
ms.topic: tutorial
ms.date: 10/09/2020
ms.custom: devx-track-python
ms.openlocfilehash: 333cda811133e9ce4e83730b038a7d84b40b7fa1
ms.sourcegitcommit: ca7b58f60dd02709977b35175b43be582b868b03
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92629938"
---
# <a name="tutorial-deploy-a-django-web-app-with-postgresql-using-the-azure-portal"></a>Руководство по Развертывание веб-приложения Django с PostgreSQL с помощью портала Azure

На портале Azure вы можете развернуть управляемое данными веб-приложение Python [Django](https://www.djangoproject.com/) в [Службе приложений Azure](/azure/app-service/overview#app-service-on-linux) и подключить его к [Базе данных Azure для PostgreSQL](/azure/postgresql/). Вы можете начать с бесплатного уровня и позже вертикально увеличить масштаб.

Источником кода веб-приложения в этом случае является репозиторий GitHub. Вы настроите веб-приложение для непрерывного развертывания из GitHub. После настройки вы можете выполнить дальнейшую разработку на локальном компьютере и зафиксировать изменения в репозитории. Веб-приложение в Azure затем автоматически развертывает эти изменения.

В этом руководстве показано, как использовать портал Azure для выполнения следующих задач:

> [!div class="checklist"]
> - подготовка веб-приложения в Azure, которое развертывается из репозитория GitHub;
> - подготовка сервера PostgreSQL и базы данных в Azure и подключение ее к веб-приложению;
> - обновление кода и фиксация изменений для автоматического повторного развертывания из GitHub;
> - просмотр журналов диагностики;
> - управление веб-приложением на портале Azure.

Вы также можете использовать **[версию этого руководства для Azure CLI](/azure/app-service/tutorial-python-postgresql-app)** .

## <a name="fork-the-sample-repository"></a>Создание вилки репозитория с примером

В браузере перейдите по адресу [https://github.com/Azure-Samples/djangoapp](https://github.com/Azure-Samples/djangoapp) и создайте вилку репозитория в своей учетной записи GitHub.

Вилка позволит вносить изменения для повторного развертывания кода на более позднем этапе.

**(Необязательно) Сведения о примере.** Пример djangoapp содержит управляемое данными приложение Django для опросов, которое вы можете [создать](https://docs.djangoproject.com/en/2.1/intro/tutorial01/), как описано в документации по Django. В примере поддерживается [контрольный список развертывания Django](https://docs.djangoproject.com/en/2.1/howto/deployment/checklist/) для запуска в производственной среде, например в Службе приложений Azure. (Такие изменения предназначены для работы в любой производственной среде, а не только в Azure.)

- Параметры для работы в производственной среде хранятся в файле *azuresite/production.py*. Сведения о разработке хранятся в файле *azuresite/settings.py*.

- Приложение использует параметры для работы в производственной среде, если для переменной среды `DJANGO_ENV` задано значение production. Для работы с руководством эта переменная среды создается позже вместе с другими переменными, используемыми для настройки базы данных PostgreSQL.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="provision-the-web-app-in-azure"></a>Подготовка веб-приложения в Azure

1. Откройте [портал Azure](https://portal.azure.com).

1. Выберите **Создать ресурс** , после чего откроется страница **Создать**.

1. Найдите и выберите **Веб-приложение**.

1. На странице **Создание веб-приложения** введите следующие сведения:

    | Поле | Значение |
    | --- | --- |
    | Подписка | Выберите нужную подписку, если она отличается от используемой по умолчанию. |
    | Группа ресурсов | Выберите **Создать** и введите DjangoPostgres-Tutorial-rg. |
    | Имя приложения. | Имя веб-приложения, уникальное во всех службах Azure (URL-адрес приложения: `https://<app-name>.azurewebsites.net`). Допустимые символы: `A`-`Z`, `0`-`9` и `-`. Рекомендуется использовать сочетание названия компании и идентификатора приложения. |
    | Публикация | Выберите **Код**. |
    | Стек среды выполнения | Выберите **Python 3.8** в раскрывающемся списке. |
    | Регион | Выберите ближайшее расположение. |
    | План Linux | Портал внесет в это поле имя плана Службы приложений с учетом вашей группы ресурсов. Если вы хотите изменить имя, выберите **Создать**. |
    | Номер SKU и размер | Чтобы повысить производительность, используйте план по умолчанию, хотя за него взимается плата в подписке. Чтобы плата не взималась, выберите **Изменить размер** , **Разработка и тестирование** , **B1** (бесплатно в течение 30 дней) и щелкните **Применить**. Вы можете масштабировать план позже, чтобы повысить производительность. |

1. Выберите **Проверка и создание** , а затем нажмите **Создать**. Azure может потребоваться несколько минут на подготовку веб-приложения.

1. После завершения подготовки выберите **Перейти к ресурсу** , чтобы открыть страницу обзора для веб-приложения. Не закрывайте это окно браузера или вкладку, так как они понадобятся для выполнения следующих шагов.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="provision-the-postgresql-database-server-in-azure"></a>Подготовка сервера базы данных PostgreSQL в Azure

1. Откройте новое окно браузера или вкладку на [портале Azure](https://portal.azure.com). Вам понадобится новая вкладка для подготовки базы данных, так как вам нужно будет перенести некоторые данные со страницы базы данных на страницу веб-приложения, открытую ранее.

1. Выберите **Создать ресурс** , после чего откроется страница **Создать**.

1. Найдите и выберите **База данных Azure для PostgreSQL**.

1. На следующей странице выберите **Создать** в разделе **Отдельный сервер**.

1. На странице **Отдельный сервер** введите следующие сведения:

    | Поле | Значение |
    | --- | --- |
    | Подписка | Выберите нужную подписку, если она отличается от используемой по умолчанию. |
    | Группа ресурсов | Выберите группу DjangoPostgres-Tutorial-rg, созданную ранее. |
    | Имя сервера | Имя сервера базы данных, уникально доступное в Azure (URL-адрес сервера базы данных становится `https://<server-name>.postgres.database.azure.com`). Допустимые символы: `A`-`Z`, `0`-`9` и `-`. Рекомендуется использовать сочетание названия компании и идентификатора сервера. |
    | Источник данных | **None** |
    | Расположение | Выберите ближайшее расположение. |
    | Версия | Используйте значение по умолчанию (последняя версия). |
    | Вычисления и хранение | Выберите **Настроить сервер** , **Базовый** и **5-е поколение**. Задайте для параметра **Виртуальное ядро** значение 1, для параметра **Хранилище**  — значение 5 ГБ, а затем нажмите **OK**. Эта конфигурация позволяет подготовить самый недорогой сервер для PostgreSQL в Azure. Возможно, у вас также есть деньги на счете в Azure, которые покроют стоимость сервера. |
    | Имя администратора, пароль, подтверждение пароля | Введите учетные данные для учетной записи администратора на сервере базы данных. Запишите эти учетные данные, так как они понадобятся вам позже при работе с этим руководством. Примечание. Не включайте символ `$` в имя пользователя или пароль. Позже вы создадите переменные среды с этими значениями, где символу `$` отведена особая роль в контейнере Linux, используемом для запуска приложений Python. |

1. Выберите **Проверить и создать** , а затем — **Создать**. Azure может потребоваться несколько минут на подготовку веб-приложения.

1. После завершения подготовки выберите **Перейти к ресурсу** , чтобы открыть страницу обзора для сервера базы данных.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="create-the-pollsdb-database-on-the-postgresql-server"></a>Создание базы данных pollsdb на сервере PostgreSQL

В этом разделе описано, как подключиться к серверу базы данных в Azure Cloud Shell и выполнить команду PostgreSQL для создания базы данных pollsdb на сервере. Эта базы данных требуется для работы примера приложения.

1. На странице обзора для сервера PostgreSQL выберите **Безопасность подключения** в разделе **Параметры** слева.

    ![Настройки правила брандмауэра на странице безопасности подключения к порталу](media/tutorial-python-postgresql-app-portal/server-firewall-rules.png)

1. Нажмите кнопку **Добавить 0.0.0.0–255.255.255.255** , а затем выберите **Продолжить** в появившемся всплывающем сообщении. После этого нажмите **Сохранить** в верхней части страницы. Так вы добавите правило, разрешающее подключение к серверу базы данных из Cloud Shell, а также через SSH (как описано в следующем разделе для переноса моделей данных Django).

1. Откройте Azure Cloud Shell на портале Azure, щелкнув значок Cloud Shell в верхней части окна.

    ![Кнопка Cloud Shell на панели инструментов на портале Azure](media/tutorial-python-postgresql-app-portal/portal-launch-icon.png)

1. В Cloud Shell введите следующую команду.

    ```bash
    psql --host=<server-name>.postgres.database.azure.com --port=5432 --username=<user-name>@<server-name> --dbname=postgres
    ```

    Замените `<server-name>` и `<user-name>` именами, которые вы использовали ранее при настройке сервера. Обратите внимание, что в соответствии с требованиями Postgres полное имя пользователя имеет следующий формат: `<user-name>@<server-name>`.

    Вы можете скопировать приведенную выше команду и вставить ее в Cloud Shell, щелкнув правой кнопкой мыши и выбрав **Вставить**.

    В ответ на запрос введите пароль администратора.

1. После успешного подключения оболочки вы увидите запрос `postgres=>`. Этот запрос означает, что вы подключены к базе данных администрирования по умолчанию с именем postgres. (База данных postgres не предназначена для использования приложением.)

1. По запросу выполните команду `CREATE DATABASE pollsdb;`. Обязательно включите точку с запятой, завершающую команду.

1. Если база данных создана успешно, команда должна отобразить `CREATE DATABASE`. Чтобы проверить, что база данных создана, выполните команду `\c pollsdb`. Эта команда должна изменить запрос на `pollsdb=>`, что означает успешное выполнение.

1. Выйдите из psql, выполнив команду `exit`.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="connect-the-database"></a>Подключение к базе данных

В этом разделе описано, как создать параметры для веб-приложения, которые требуются для его подключения к базе данных `pollsdb`. Эти параметры отображаются в коде приложения в виде переменных среды. (Дополнительную информацию см. в разделе [Доступ к переменным среды](/azure/app-service/configure-language-python#access-environment-variables).)

1. Вернитесь на вкладку или в окно браузера к веб-приложению, созданному ранее.

1. Выберите **Конфигурация** в разделе **Параметры** слева и **Параметры приложения** в верхней части страницы.

    ![Настройка параметров веб-приложений на портале](media/tutorial-python-postgresql-app-portal/web-app-settings.png)

1. С помощью кнопки **Новый параметр приложения** создайте параметры для каждого из следующих значений, требуемых для работы с примером djangoapp.

    | Имя параметра | Значение |
    | --- | --- |
    | DJANGO_ENV | `production` (Это значение указывает приложению использовать производственную конфигурацию, как описано ранее в [обзоре примера](#fork-the-sample-repository).) |
    | DBHOST | Имя сервера базы данных из предыдущего раздела; то есть `<server-name>` часть URL-адреса сервера, которая предшествует `.postgres.database.azure.com`. (Код в *azuresite/production.py* автоматически формирует полный URL-адрес.) |
    | DBNAME | `pollsdb` |
    | DBUSER | Имя пользователя администратора, используемое при подготовке базы данных. (В примере кода автоматически добавляется часть `@<server-name>`; см. *azuresite/production.py*.) |
    | DBPASS | Созданный ранее пароль администратора. |

    Как отмечалось ранее, не следует включать символ `$` в имя пользователя или пароль, так как этот символ экранируется в переменных среды в контейнере Linux, где размещаются приложения Python.

1. Нажмите **Сохранить** и **Продолжить** , чтобы применить параметры.

    > [!IMPORTANT]
    > Обязательно нажмите **Сохранить** после внесения изменений. Все параметры, созданные с помощью кнопки **Создать параметр приложения** , не будут применены, пока вы не нажмете кнопку **Сохранить**.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="deploy-app-code-to-the-web-app-from-a-repository"></a>Развертывание кода приложения в веб-приложении из репозитория

После настройки базы данных и подключения вы можете настроить веб-приложение для развертывания кода непосредственно из репозитория GitHub.

1. В окне браузера или на вкладке веб-приложения выберите **Центр развертывания** в разделе **Развертывание** слева.

1. На шаге **Система управления версиями** выберите **GitHub** и **Авторизовать** (при необходимости). Затем следуйте подсказкам для входа в систему или выберите **Продолжить** , чтобы использовать текущее имя для входа в GitHub.

1. На шаге **Поставщик сборки** выберите **Служба сборки службы приложений** и щелкните **Продолжить**.

1. На шаге **Настройка** выберите следующие значения:

    | Поле | Значение |
    | --- | --- |
    | План | Учетная запись GitHub, в которой вы создали вилку примера репозитория. |
    | Хранилище | djangoapp |
    | Ветвь | master |

1. Нажмите **Продолжить** , чтобы выбрать репозиторий, а затем нажмите **Готово**. Azure развернет код в течение нескольких секунд и запустит приложение.

    Служба приложений определяет проекты Django по файлу *wsgi.py* в каждой подпапке. Обнаружив такой файл, Служба приложений загружает веб-приложение Django. Дополнительные сведения см. в статье о [настройке встроенного образа Python](/azure/app-service/configure-language-python).

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="run-django-database-migrations"></a>Перенос базы данных Django

После развертывания кода и настройки базы данных приложение почти готово к использованию. Остается только задать необходимую схему в самой базе данных. Для этого нужно перенести модели данных из приложения Django в базу данных.

1. В окне браузера или на вкладке веб-приложения выберите **SSH** (в разделе **Средства разработки** слева), а затем щелкните **Перейти** , чтобы открыть консоль SSH на сервере веб-приложения. Первое подключение может занять некоторое время, так как предварительно нужно запустить контейнер веб-приложения.

1. В консоли перейдите к папке веб-приложения:

    ```bash
    cd site/wwwroot
    ```

1. Активируйте виртуальную среду контейнера:

    ```bash
    source /antenv/bin/activate
    ```

1. Установите пакеты Python:

    ```bash
    pip install -r requirements.txt
    ```

1. Перенесите базу данных:

    ```bash
    python manage.py migrate
    ```

1. Создайте имя входа администратора для приложения:

    ```bash
    python manage.py createsuperuser
   ```

    Команда `createsuperuser` требует указать учетные данные суперпользователя (или администратора) Django, которые используются в веб-приложении. Для работы с этим руководством используйте имя пользователя по умолчанию `root`, затем нажмите клавишу **ВВОД** , чтобы адрес электронной почты оставался пустым, и введите `Pollsdb1` в качестве пароля.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

### <a name="create-a-poll-question-in-the-app"></a>Создание вопроса опроса в приложении

Теперь вы можете выполнить небольшой тест приложения, чтобы продемонстрировать его работу с базой данных PostgreSQL.

1. В окне браузера или на вкладке веб-приложения вернитесь на страницу **Обзор** , а затем выберите **URL-адрес** для веб-приложения (в виде `http://<app-name>.azurewebsites.net`).

1. В приложении должно отобразиться сообщение No polls are available (Доступных опросов нет), так как в базе данных нет отдельных опросов.

1. Перейдите по адресу `http://<app-name>.azurewebsites.net/admin` (страница администрирования Django) и выполните вход с учетными данными суперпользователя из предыдущего раздела (`root` и `Pollsdb1`).

1. В разделе **Polls** (Опросы) щелкните **Add** (Добавить) возле поля **Questions** (Вопросы) и создайте вопрос с несколькими вариантами ответа.

1. Еще раз перейдите по адресу `http://<app-name>.azurewebsites.net/`, чтобы убедиться, что пользователь видит вопросы. Ответьте на вопросы произвольным образом, чтобы наполнить базу данных.

**Поздравляем!** Вы запустили веб-приложение Python Django в Службе приложений Azure для Linux с активной базой данных PostgreSQL.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="update-the-app-and-redeploy"></a>Обновление и повторное развертывание приложения

Как описано ранее в этом руководстве, Azure повторно развертывает код приложения при фиксации изменений в репозитории GitHub.

Но если вы измените модели данных в приложении Django, вам нужно будет перенести такие изменения в базу данных:

1. Снова подключитесь к веб-приложению через SSH, как описано в разделе [Перенос базы данных Django](#run-django-database-migrations).

1. Перейдите в папку приложения с помощью команды `cd site/wwwroot`.

1. Активируйте виртуальную среду, выполнив команду `source /antenv/bin/activate`.

1. Снова запустите миграцию с помощью команды `python manage.py migrate`.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="view-diagnostic-logs"></a>просмотр журналов диагностики;

Вы можете получить доступ к журналам консоли, созданным в контейнере, в котором размещено приложение в Azure.

На странице веб-приложения на портале Azure выберите **Поток журнала** в разделе **Мониторинг** слева. Журналы отображаются в виде выходных данных консоли.

Вы также можете проверить файлы журнала в браузере на странице `https://<app-name>.scm.azurewebsites.net/api/logs/docker`.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="clean-up-resources"></a>Очистка ресурсов

Вы можете не закрывать приложение и базу данных, если хотите и дальше использовать их при разработке. В противном случае, чтобы избежать постоянных расходов, удалите группу ресурсов, созданную для этого руководства. Это также приведет к удалению всех содержащихся в ней ресурсов.

1. На портале Azure введите DjangoPostgres-Tutorial-rg в строку поиска в верхней части окна, а затем выберите такое же имя в разделе **Группы ресурсов**.

1. На странице группы ресурсов выберите **Удалить группу ресурсов**.

1. При появлении запроса введите имя группы ресурсов и нажмите **Удалить**.

[Возникли проблемы? Сообщите нам!](https://aka.ms/DjangoPortalTutorialHelp)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как Служба приложений запускает приложение Python:

> [!div class="nextstepaction"]
> [Настройка приложения Python](/azure/app-service/configure-language-python)
