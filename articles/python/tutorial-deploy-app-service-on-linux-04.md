---
title: Шаг 4. Настройка пользовательского файла с командой запуска для приложений Python в Службе приложений Azure в Linux
description: Руководство, шаг 4. Инструкции по настройке способа запуска веб-приложения в Службе приложений, в частности для Django, Flask и других платформ.
ms.topic: conceptual
ms.date: 11/20/2020
ms.custom: devx-track-python, seo-python-october2019
ms.openlocfilehash: 0c7fd378fa1166113812c4748c10676030941e13
ms.sourcegitcommit: 29930f1593563c5e968b86117945c3452bdefac1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "95485653"
---
# <a name="4-configure-a-custom-startup-file-for-python-apps-on-azure-app-service"></a>4: Настройка пользовательского файла с командой запуска для приложений Python в Службе приложений Azure

[Предыдущий шаг: создание Службы приложений](tutorial-deploy-app-service-on-linux-03.md)

На этом этапе вы настроите, если потребуется, пользовательский файл запуска для приложения Python в Службе приложений Azure.

Пользовательский файл запуска полезен в следующих сценариях:

- Вам нужно запускать веб-сервер Gunicorn с дополнительными аргументами, кроме тех, которые используются по умолчанию `--bind=0.0.0.0 --timeout 600`.

- Приложение создано не на платформе Flask или Django или предназначено для другого веб-сервера.

- У приложения Flask имя основного файла кода **отличается** от стандартных вариантов *app.py* или *application.py** либо имя объекта приложения **отличается** от `app`.

    Иными словами, если в корневой папке проекта нет файла *app.py* либо *application.py*, *или* имя объекта приложения Flask отличается от `app`, вам потребуется пользовательский файл с командой запуска.

    Например, основной файл в примере кода из [шага 2](tutorial-deploy-app-service-on-linux-02.md) называется *hello.py*, а объект приложения называется `myapp`. Поэтому нужно создать пользовательский файл запуска, как показано в этой статье.

Дополнительные сведения см. в разделе ["Процесс запуска контейнера" статьи о настройке приложений Python](/azure/app-service/configure-language-python#container-startup-process).

## <a name="create-a-startup-file"></a>Создание файла запуска

Если вам нужен пользовательский файл запуска, выполните следующие действия:

1. Создайте в проекте файл с именем *startup.txt*, *startup.sh* или любым другим именем, который содержит команды запуска. Подробные инструкции для Django, Flask и других платформ см. в следующих разделах этой статьи.

    При необходимости файл запуска может содержать несколько команд.

1. Сохраните этот файл в репозитории кода, чтобы его можно было развернуть с остальной частью приложения.

1. В области **Azure: Служба приложений** разверните Службу приложений, щелкните правой кнопкой мыши **Параметры приложения** и выберите **Открыть на портале**:

    ![Пункт "Открыть параметры приложения на портале" в обозревателе Службы приложений](media/deploy-azure/open-application-settings-in-portal-for-app-service.png)

1. Если потребуется, выполните вход на портале Azure. Затем на странице **Конфигурация** выберите элемент **Общие параметры**, введите имя файла запуска (например, *startup.txt* или *startup.sh*) в разделе **Параметры стека** > **Команда запуска** и щелкните команду **Сохранить**.

    ![Настройка имени для файла с командой запуска на портале Azure](media/deploy-azure/enter-startup-file-for-app-service-in-the-azure-portal.png)

    > [!NOTE]
    > Вместо файла с командой запуска можно указать команду запуска непосредственно в поле **Команда запуска** на портале Azure. Но файл с командой запуска предпочтительнее, так как этот элемент конфигурации можно сохранить в репозитории, чтобы отслеживать изменения в нем и развертывать его в других экземплярах Службы приложений.

1. Служба приложений перезапускается при сохранении изменений.

    Но вы пока еще не развернули код приложения, поэтому при входе на веб-сайт пока будете получать ошибку, связанную с работой приложения. Такое сообщение означает, что сервер Gunicorn запущен, но не может найти приложение, то есть HTTP-запросы не обрабатываются. Код приложения вы развернете на следующем шаге.

## <a name="django-startup-commands"></a>Команды запуска Django

По умолчанию Служба приложений автоматически обнаруживает папку с файлом *wsgi.py* и запускает Gunicorn с помощью следующей команды:

```sh
# <module> is the folder that contains wsgi.py. If you need to use a subfolder,
# specify the parent of <module> using --chdir.
gunicorn --bind=0.0.0.0 --timeout 600 <module>.wsgi
```

Если вы хотите изменить аргументы Gunicorn, например применить `--timeout 1200`, создайте командный файл с нужными изменениями.

## <a name="flask-startup-commands"></a>Команды запуска Flask

По умолчанию контейнер Службы приложений в Linux предполагает, что вызываемый объект WSGI приложения Flask имеет имя `app`, содержится в файле с именем *application.py* или *app.py* и находится в корневой папке приложения.

Если у вас используются любые из описанных ниже вариаций, в пользовательской команде запуска необходимо задать расположение объекта приложения в формате *file:app_object*:

- **Другое имя файла и (или) объекта приложения**. Например, если вы используете основной файл кода *hello.py* и объект приложения `myapp`, используйте такую команду запуска:

    ```text
    gunicorn --bind=0.0.0.0 --timeout 600 hello:myapp
    ```

- **Файл запуска находится во вложенной папке**. Например, если вы используете файл запуска *myapp/website.py* и объект приложения `app`, с помощью аргумента Gunicorn `--chdir` укажите папку, а затем обычным образом используйте имя файла и объект приложения:

    ```text
    gunicorn --bind=0.0.0.0 --timeout 600 --chdir myapp website:app
    ```

- **Файл запуска расположен в модуле**. В коде [python-sample-vscode-flask-tutorial](https://github.com/Microsoft/python-sample-vscode-flask-tutorial) файл запуска *webapp.py* помещен в папку *hello_app*, который в свою очередь является модулем в файле *\_\_init\_\_.py*. Объект приложения имеет имя `app` и определен в файле *\_\_init\_\_.py*, а *webapp.py* использует относительный импорт.

    В такой конфигурации указание `webapp:app` для Gunicorn приводит к ошибке Attempted relative import in non-package (Попытка относительного импорта вне пакета) и сбою при запуске приложения.

    Чтобы устранить проблему, создайте специальный файл, который импортирует объект приложения из модуля, а затем настройте Gunicorn на соответствующий запуск приложения. Например, код [python-sample-vscode-flask-tutorial](https://github.com/Microsoft/python-sample-vscode-flask-tutorial) содержит файл *startup.py* со следующим содержимым:

    ```python
    # startup.py shim
    from hello_app.webapp import app
    ```

    Для него нужна такая команда запуска:

    ```text
    gunicorn --bind=0.0.0.0 --timeout 600 startup:app
    ```


## <a name="startup-commands-for-other-frameworks-and-web-servers"></a>Команды запуска для других платформ и веб-серверов

В контейнере Службы приложений, где работают приложения Python, Django и Flask установлены по умолчанию, а также запущен веб-сервер Gunicorn.

Чтобы использовать другую платформу, отличную от Django или Flask (например, Falcon, FastAPI и т. д.), либо другой веб-сервер, сделайте следующее:

- Укажите имя платформы и (или) веб-сервера в файле *requirements.txt*.

- В команде запуска задайте вызываемый объект WSGI, как описано в [предыдущем разделе для Flask](#flask-startup-commands).

- Чтобы запустить веб-сервер, отличный от Gunicorn, используйте команду `python -m`вместо прямого вызова сервера. Например, следующая команда запускает сервер Uvicorn. При этом предполагается, что вызываемый объект WSGI имеет имя `app` и указан в файле *application.py*.

    ```sh
    python -m uvicorn application:app --host 0.0.0.0
    ```

    Вы используете `python -m`, так как веб-серверы, установленные с использованием файла *requirements.txt*, не добавляются в глобальную среду Python. Поэтому их нельзя вызвать напрямую. Команда `python -m` вызывает сервер из текущей виртуальной среды.

> [!div class="nextstepaction"]
> [Файл запуска настроен — перейти к шагу 5 >>>](tutorial-deploy-app-service-on-linux-05.md)

[Возникли проблемы? Сообщите нам!](https://aka.ms/FlaskVSCQuickstartHelp)
