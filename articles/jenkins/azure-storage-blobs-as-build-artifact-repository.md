---
title: Руководство. Использование службы хранилища Azure для артефактов сборки
description: Узнайте, как использовать службы BLOB-объектов Azure в качестве репозитория для артефактов сборки, созданных решением непрерывной интеграции Jenkins.
keywords: Jenkins, Azure, DevOps, хранилище, CI/CD, артефакты сборки
ms.topic: article
ms.date: 08/13/2019
ms.openlocfilehash: ac2ccc974c13a9dc19e1098d95ec484458377304
ms.sourcegitcommit: 9ff9b51ab21c93bfd61e480c6ff8e39c9d4bf02e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/27/2020
ms.locfileid: "82170170"
---
# <a name="tutorial-use-azure-storage-for-build-artifacts"></a>Руководство по использованию службы хранилища Azure для артефактов сборки

В этой статье демонстрируется использование хранилища BLOB-объектов в качестве репозитория для артефактов сборки, созданных решением непрерывной интеграции Jenkins, или в качестве источника скачиваемых файлов для процесса сборки. Одним из сценариев, где это может оказаться полезным, является программирование в гибкой среде разработки (с помощью Java или других языков), сборка выполняется на основе непрерывной интеграции, и вам требуется репозиторий для артефактов построения, чтобы можно было, например, использовать их совместно с другими членами организации, вашими клиентами или вести архив. Еще один сценарий связан с ситуацией, когда задание построения само требует других файлов, например, зависимостей для загрузки в качестве входа построения.

В этом руководстве будет использоваться подключаемый модуль службы хранилища Azure для решения непрерывной интеграции Jenkins, предоставляемый корпорацией Майкрософт.

## <a name="jenkins-overview"></a>Общие сведения о Jenkins

Jenkins обеспечивает непрерывную интеграцию программного проекта, позволяя разработчикам легко интегрировать свои изменения кода и автоматизировать процесс построения сборок, что повышает производительность их труда. Для построений осуществляется контроль версий, а артефакты построения можно загрузить в разные репозитории. В этом разделе демонстрируется использование хранилища BLOB-объектов Azure в качестве репозитория артефактов сборки. Здесь также рассматривается загрузка зависимостей из хранилища blob-объектов Azure.

Дополнительные сведения о Jenkins см. в разделе [Знакомство с Jenkins](https://wiki.jenkins-ci.org/display/JENKINS/Meet+Jenkins).

## <a name="benefits-of-using-the-blob-service"></a>Преимущества использования службы BLOB-объектов

Преимущества использования службы BLOB-объектов для размещения артефактов построения при гибкой разработке включают в себя следующее:

* Высокая доступность артефактов построения и (или) загружаемых зависимостей.
* Производительность при отправке артефактов построения решением Jenkins CI.
* Производительность при загрузке артефактов построения клиентами и партнерами.
* Контроль политики доступа пользователей с возможностью выбора между анонимным доступом, общим доступом на основе срока действия, доступом по подписи, закрытым доступом и т. п.

## <a name="prerequisites"></a>Предварительные требования

* Решение непрерывной интеграции Jenkins.
  
    Если у вас нет решения Jenkins, его можно запустить следующим образом:
  
  1. На компьютере с поддержкой Java скачайте файл jenkins.war по адресу <https://jenkins-ci.org>.
  2. В командной строке, открытой на папке с файлом jenkins.war, выполните следующую команду:
     
      `java -jar jenkins.war`

  3. В браузере перейдите по адресу `http://localhost:8080/`, чтобы открыть панель мониторинга Jenkins, которую вы будете использовать для установки и настройки подключаемого модуля службы хранилища Azure.
     
      Хотя обычно решение Jenkins настраивается на запуск в качестве службы, в рамках данного учебника будет достаточно запуска WAR-файла Jenkins в командной строке.
* Учетная запись Azure. Вы можете зарегистрировать учетную запись Azure по адресу <https://www.azure.com>.
* Учетная запись хранения Azure. Если у вас еще нет учетной записи хранения, ее можно создать с помощью процедуры [Создание учетной записи хранения](/azure/storage/common/storage-account-create.md).
* Знакомство с решением Jenkins CI рекомендуется, но не является обязательным, поскольку ниже будет приведен простой пример, показывающий этапы использования службы BLOB-объектов в качестве репозитория для артефактов построения решения Jenkins CI.

## <a name="how-to-use-the-blob-service-with-jenkins-ci"></a>Как использовать службу больших двоичных объектов с решением непрерывной интеграции Jenkins

Чтобы использовать службу BLOB-объектов с решением Jenkins, необходимо установить подключаемый модуль хранилища Azure, настроить этот модуль на использование учетной записи хранения, а затем создать действие, выполняемое после построения и отправляющее артефакты построения в вашу учетную запись хранения. Эти действия описаны в следующих разделах.

## <a name="how-to-install-the-azure-storage-plugin"></a>Как установить подключаемый модуль службы хранилища Azure

1. На панели мониторинга Jenkins выберите **Manage Jenkins** (Управление Jenkins).
2. На странице **Manage Jenkins** (Управление Jenkins) выберите **Manage Plugins** (Управление подключаемыми модулями).
3. Перейдите на вкладку **Available** (Доступно).
4. В разделе **Artifact Uploaders** (Средство отправки артефактов) установите флажок **Microsoft Azure Storage plugin** (Подключаемый модуль хранилища Azure).
5. Щелкните **Install without restart** (Установить без перезагрузки) или **Download now and install after restart** (Скачать сейчас и установить позднее).
6. Перезапустите Jenkins.

## <a name="how-to-configure-the-azure-storage-plugin-to-use-your-storage-account"></a>Как настроить подключаемый модуль службы хранилища Azure для использования своей учетной записи хранения

1. На панели мониторинга Jenkins выберите **Manage Jenkins** (Управление Jenkins).
2. На странице **Manage Jenkins** (Управление Jenkins) щелкните **Configure System** (Настройка системы).
3. В разделе **Microsoft Azure Storage Account Configuration** (Настройка учетной записи хранения Azure):
   1. Введите имя своей учетной записи хранения, которое можно получить на [портале Azure](https://portal.azure.com).
   2. Введите ключ учетной записи хранения, который также можно получить через [портал Azure](https://portal.azure.com).
   3. Используйте значение по умолчанию для параметра **Blob Service Endpoint URL** (URL-адрес конечной точки службы BLOB-объектов) при использовании глобального облака Azure. При использовании другого облака Azure используйте конечную точку, указанную для вашей учетной записи хранения на [портале Azure](https://portal.azure.com). 
   4. Щелкните **Validate storage credentials** (Проверить учетные данные хранилища) для проверки учетной записи хранения. 
   5. [Необязательно.] Если у вас есть дополнительные учетные записи хранения, которые требуется сделать доступными для решения непрерывной интеграции Jenkins, щелкните **Add more Storage Accounts** (Добавить дополнительные учетные записи хранения).
   6. Нажмите кнопку **Save** (Сохранить), чтобы сохранить настройки.

## <a name="how-to-create-a-post-build-action-that-uploads-your-build-artifacts-to-your-storage-account"></a>Создание действия, выполняемого после построения и отправляющего артефакты построения в вашу учетную запись хранения

В учебных целях сначала необходимо создать задание, которое создаст несколько файлов, а затем добавить выполняемое после сборки действие для отправки этих файлов в вашу учетную запись хранения.

1. На панели мониторинга Jenkins выберите **New Item** (Создать элемент).
2. Назовите задание **MyJob**, щелкните **Build a free-style software project** (Выполнить сборку проекта ПО в свободном стиле) и нажмите кнопку **OK**.
3. В разделе **Build** (Сборка) конфигурации задания щелкните **Add build step** (Добавить шаг сборки) и выберите **Execute Windows batch command** (Выполнить пакетную команду Windows).
4. В поле **Command**(Команда) используйте следующие команды:

    ```   
    md text
    cd text
    echo Hello Azure Storage from Jenkins > hello.txt
    date /t > date.txt
    time /t >> date.txt
    ```

5. В разделе конфигурации задания **Post-build Actions** (Действия после сборки) щелкните **Add post-build action** (Добавить действие после сборки) и выберите **Upload artifacts to Azure Blob storage** (Передать артефакты в хранилище BLOB-объектов Azure).
6. В поле **Storage Account Name**(Имя учетной записи хранения) выберите используемую учетную запись хранения.
7. Для поля **Container name** задайте имя контейнера. (Если этот контейнер не существует, он будет создан при передаче артефактов построения.) Вы можете использовать переменные среды, поэтому для данного примера введите имя контейнера `${JOB_NAME}`.
   
    **Подсказка**
   
    Под разделом **Command** (Команда), где вы указали скрипт в поле **Execute Windows batch command** (Выполнить пакетную команду Windows), находится ссылка на переменные среды, которые распознаются в решении Jenkins. Выберите эту ссылку, чтобы узнать имена и описание переменных среды. Переменные среды, которые содержат специальные знаки, такие как переменная среды **BUILD_URL**, нельзя использовать в качестве имени контейнера или общего виртуального пути.
8. Щелкните **Make new container public by default** (Сделать новый контейнер общедоступным по умолчанию) для этого примера. (Если вы хотите использовать частный контейнер, необходимо создать подписанный URL-адрес. Это выходит за рамки данной статьи. Дополнительные сведения о подписанных URL-адресах см. в статье [Использование подписанных URL-адресов (SAS)](/azure//storage/common/storage-sas-overview.md)).
9. [Необязательно.] Щелкните **Clean container before uploading** (Очистить контейнер перед передачей), если хотите, чтобы контейнер был очищен перед передачей артефактов сборки (не устанавливайте этот флажок, если не хотите очищать содержимое контейнера).
10. В поле **List of Artifacts to upload** (Список передаваемых артефактов) введите значение `text/*.txt`.
11. Для параметра **Common virtual path for uploaded artifacts** (Общий виртуальный путь для переданых артефактов) введите значение `${BUILD\_ID}/${BUILD\_NUMBER}` (для целей данного руководства).
12. Нажмите кнопку **Save** (Сохранить), чтобы сохранить настройки.
13. На панели мониторинга Jenkins щелкните **Build Now** (Выполнить сборку), чтобы запустить **MyJob**. Изучите выходные данные в консоли для определения состояния. Сообщения о состоянии для хранилища Azure будут включены в выходные данные консоли, когда действие после построения начнет передавать артефакты построения.
14. После успешного завершения задания можно просмотреть артефакты построения, открыв общедоступный BLOB-объект.
    1. Войдите на [портал Azure](https://portal.azure.com).
    2. Выберите **Хранилище**.
    3. Щелкните имя учетной записи хранения, используемой для решения Jenkins.
    4. Выберите **Контейнеры**.
    5. Выберите контейнер с именем **myjob**, которое является копией имени задания Jenkins, написанного в нижнем регистре. Имена контейнеров и BLOB-объектов в хранилище Azure отображаются строчными буквами (и с учетом регистра). В списке больших двоичных объектов для контейнера с именем **myjob** вы увидите **hello.txt** и **date.txt**. Скопируйте URL-адрес любого из этих элементов и откройте его в браузере. Вы увидите текстовый файл, который был загружен в качестве артефакта построения.

На каждое задание может быть создано только одно действие после построения, которое отправляет артефакты в хранилище blob-объектов Azure. Одно действие после сборки для передачи артефактов в хранилище BLOB-объектов Azure может определять различные файлы (в том числе подстановочные знаки) и пути для файлов в **List of Artifacts to upload** (Список передаваемых артефактов) с использованием точки с запятой в качестве разделителя. Например, если операция сборки Jenkins создает JAR-файлы и TXT-файлы в папке **build** рабочей области, при этом их нужно отправить в хранилище BLOB-объектов Azure, укажите в поле **List of Artifacts to upload** (Список передаваемых артефактов) следующее значение: `build/\*.jar;build/\*.txt`. Чтобы задать путь для использования в имени blob-объекта, можно также использовать синтаксис с двойным двоеточием. Например, если необходимо передать JAR-файлы с использованием **двоичных файлов** в пути к большому двоичному объекту, а TXT-файлы — с использованием **уведомлений** в пути большому двоичному объекту, используйте для параметра **List of Artifacts to upload** (Список передаваемых артефактов) следующее значение: `build/\*.jar::binaries;build/\*.txt::notices`.

## <a name="how-to-create-a-build-step-that-downloads-from-azure-blob-storage"></a>Создание шага построения для загрузки blob-объектов из хранилища Azure

Ниже описывается настройка шага сборки для скачивания элементов из хранилища BLOB-объектов Azure, что удобно, если вы хотите включить эти элементы в сборку. Пример использования этого шаблона состоит из JAR-файлов, которые можно сохранить в хранилище BLOB-объектов Azure.

1. В разделе **Build** (Сборка) конфигурации задания щелкните **Add build step** (Добавить шаг сборки) и выберите **Download from Azure Blob storage** (Скачать из хранилища BLOB-объектов Azure).
2. В поле **Storage Account Name**(Имя учетной записи хранения) выберите используемую учетную запись хранения.
3. Для поля **Container name**(Имя контейнера) задайте имя контейнера с blob-объектами, которое нужно загрузить. Можно использовать переменные среды.
4. Для поля **Blob name**задайте имя blob-объекта. Можно использовать переменные среды. В то же время можно использовать звездочку как подстановочный символ после задания начальной буквы (букв) имени blob-объекта. Например, имя **project\\** * будет определять все BLOB-объекты, имя которых начинается с **project**.
5. [Необязательно] Для поля **Download path**(Путь загрузки) задайте путь компьютера с Jenkins, на который вы хотите загрузить файлы из хранилища blob-объектов Azure. Переменные среды также могут использоваться. (Если не задать значения для поля **Download path**, файлы из хранилища blob-объектов Azure будут загружаться в рабочую область задания.)

При наличии дополнительных элементов, которые нужно загрузить из хранилища blob-объектов Azure можно создать дополнительные шаги построения.

После выполнения построения можно проверить выход консоли истории построения или взглянуть на местоположение для загрузки и удостовериться, успешно ли загрузились необходимы blob-объекты.  

## <a name="components-used-by-the-blob-service"></a>Компоненты, используемые службой BLOB-объектов

В следующем разделе приведен обзор компонентов службы BLOB-объектов.

* **Учетная запись хранения**. Весь доступ к хранилищу Azure осуществляется с помощью учетной записи хранения. Это самое высокоуровневое пространство имен для доступа к большим двоичным объектам. Учетная запись может содержать неограниченное число контейнеров при условии, что их общий размер не достигает 100 ТБ.
* **Контейнер.** Контейнер обеспечивает группирование набора больших двоичных объектов. Все BLOB-объекты должны содержаться в контейнере. Учетная запись может содержать неограниченное число контейнеров. Контейнер может хранить неограниченное количество больших двоичных объектов.
* **Большой двоичный объект.** Файл любого типа и размера. Существует два типа BLOB-объектов, которые могут храниться в хранилище Azure: блочные и страничные. Большинство файлов являются блочными BLOB-объектами. Единичный блочный BLOB-объект может иметь размер до 200 ГБ. В этом учебнике используются блочные BLOB-объекты. Страничные BLOB-объекты, другой BLOB-объект могут иметь размер до 1 ТБ. Они более эффективны, когда диапазоны байтов в файле часто изменяются. Дополнительные сведения о BLOB-объектах см. в разделе [Основные сведения о блочных, добавочных и страничных BLOB-объектах](https://msdn.microsoft.com/library/azure/ee691964.aspx).
* **Формат URL-адреса**. К большому двоичному объекту можно обратиться, используя следующий формат URL-адреса:
  
    `http://storageaccount.blob.core.windows.net/container_name/blob_name`
  
    (Приведенный выше формат применяется для глобального облака Azure. При использовании другого облака Azure используйте конечную точку на [портале Azure](https://portal.azure.com), чтобы определить конечную точку URL-адреса.)
  
    В указанном выше формате `storageaccount` представляет имя вашей учетной записи хранения, `container_name` представляет имя контейнера, а `blob_name` представляет имя BLOB-объекта соответственно. В имени контейнера может использовать несколько путей, разделенных косой чертой — **/** . Примером имени контейнера в данном руководстве было имя **MyJob**, а имя **${BUILD\_ID}/${BUILD\_NUMBER}** использовалось в качестве общего виртуального пути, в результате чего большой двоичный объект имеет следующий URL-адрес:
  
    `http://example.blob.core.windows.net/myjob/2014-04-14_23-57-00/1/hello.txt`

## <a name="troubleshooting-the-jenkins-plugin"></a>Устранение неполадок подключаемого модуля Jenkins

Если вы столкнулись с ошибками, которые касаются подключаемых модулей Jenkins, сообщите о проблеме конкретного компонента в [JENKS JIRA](https://issues.jenkins-ci.org/).

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Jenkins в Azure](/azure/Jenkins/)