---
title: Руководство. Создание гибридной сети со звездообразной топологией с помощью Terraform в Azure
description: Узнайте, как создать эталонную архитектуру всей гибридной сети в Azure с помощью Terraform.
ms.topic: tutorial
ms.date: 10/26/2019
ms.custom: devx-track-terraform
ms.openlocfilehash: 7fd6de18404f6c71184f17510699c6eb2a7be16b
ms.sourcegitcommit: 16ce1d00586dfa9c351b889ca7f469145a02fad6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2020
ms.locfileid: "88241126"
---
# <a name="tutorial-create-a-hub-and-spoke-hybrid-network-topology-in-azure-using-terraform"></a>Руководство по Создание гибридной сети со звездообразной топологией с помощью Terraform в Azure

В этом цикле учебников показано, как использовать Terraform для реализации в Azure [звездообразной топологии сети](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke). 

Звездообразная топология — это способ изоляции рабочих нагрузок при совместном использовании общих служб. В число этих служб входят службы идентификации и обеспечения безопасности. Концентратор — это виртуальная сеть, которая выступает в качестве центральной точки подключения к локальной сети. Периферийные зоны — это виртуальные сети, которые устанавливают пиринг с концентратором. Общие службы развертываются в концентраторе, а отдельные рабочие нагрузки — в периферийных сетях.

В рамках этого руководства рассматриваются следующие задачи:

> [!div class="checklist"]
> * размещение ресурсов эталонной архитектуры звездообразной гибридной сети с помощью HCL (язык HashiCorp);
> * создание ресурсов устройства сети-концентратора с помощью Terraform;
> * создание сети-концентратора в Azure в качестве общей точки для всех ресурсов с помощью Terraform;
> * создание отдельных рабочих нагрузок в качестве периферийных виртуальных сетей в Azure с помощью Terraform;
> * установка шлюзов и подключений между локальными сетями и сетями Azure с помощью Terraform;
> * создание пирингов между виртуальной и периферийной сетями с помощью Terraform.

[!INCLUDE [hashicorp-support.md](includes/hashicorp-support.md)]

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [open-source-devops-prereqs-azure-subscription.md](../includes/open-source-devops-prereqs-azure-subscription.md)]

- **Установите и настройте Terraform**. Чтобы подготовить виртуальные машины и другую инфраструктуру в Azure, [установите и настройте Terraform](get-started-cloud-shell.md).

## <a name="hub-and-spoke-topology-architecture"></a>Архитектура звездообразной топологии

В звездообразной топологии концентратор является виртуальной сетью. Виртуальная сеть выступает в качестве центральной точки подключения к локальной сети. Периферийные зоны — это виртуальные сети, которые устанавливают пиринг с концентратором и могут использоваться для изоляции рабочих нагрузок. Трафик передается между локальным центром обработки данных и концентратором через подключение ExpressRoute или VPN-шлюз. На следующем изображении показаны компоненты в звездообразной топологии:

![Архитектура звездообразной топологии в Azure](./media/hub-and-spoke-tutorial-series/hub-spoke-architecture.png)

## <a name="benefits-of-the-hub-and-spoke-topology"></a>Преимущества звездообразной топологии

Звездообразная топология сети — это способ изоляции рабочих нагрузок при совместном использовании общих служб. В число этих служб входят службы идентификации и обеспечения безопасности. Концентратор — это виртуальная сеть, которая выступает в качестве центральной точки подключения к локальной сети. Периферийные зоны — это виртуальные сети, которые устанавливают пиринг с концентратором. Общие службы развертываются в концентраторе, а отдельные рабочие нагрузки — в периферийных сетях. Ниже приведены некоторые преимущества звездообразной топологии сети.

- **Сокращение затрат** путем централизации служб в одном расположении, которое можно использовать для нескольких рабочих нагрузок. К этим рабочим нагрузкам относятся виртуальные сетевые модули и DNS-серверы.
- **Превышение лимитов подписки** путем пиринга виртуальных сетей из разных подписок к центральному концентратору.
- **Разделение областей ответственности** между центральным ИТ-отделом (SecOps, InfraOps) и рабочими нагрузками (DevOps).

## <a name="typical-uses-for-the-hub-and-spoke-architecture"></a>Стандартные варианты использования звездообразной архитектуры

Ниже перечислены некоторые стандартные варианты использования звездообразной архитектуры.

- У многих клиентов есть рабочие нагрузки, развернутые в различных средах. Это могут быть среды для разработки, тестирования, а также рабочие среды. Во многих случаях в этих рабочих нагрузках должны совместно использоваться службы, такие как DNS, IDS, NTP или доменные службы Active Directory. Эти общие службы могут размещаться в виртуальной сети-концентраторе. Таким образом, каждая среда развертывается в периферийной зоне для обеспечения изоляции.
- Рабочие нагрузки, которые не требуют подключения друг к другу, но требуют доступа к общим службам.
- Предприятия, которым требуется централизованный контроль аспектов безопасности.
- Предприятия, которым необходимо отдельно управлять рабочими нагрузками в каждой периферийной зоне.

## <a name="preview-the-demo-components"></a>Предварительный просмотр демонстрационных компонентов

При работе с каждым учебником из этого цикла вы будете определять различные компоненты в разных скриптах Terraform. Созданная и развернутая демонстрационная архитектура состоит из следующих компонентов.

- **Локальная сеть.** Частная локальная сеть, работающая в пределах организации. Для эталонной звездообразной архитектуры виртуальная сеть в Azure используется для моделирования локальной сети.

- **VPN-устройство**. VPN-устройство или служба предоставляет возможность внешнего подключения к локальной сети. В качестве VPN-устройства может использоваться аппаратное устройство или программное решение. 

- **Виртуальная сеть концентратора**. Концентратор представляет собой центральную точку подключения к локальной сети и место для размещения служб. Эти службы могут использоваться различными рабочими нагрузками, размещенными в периферийных виртуальных сетях.

- **Подсеть шлюза**. Шлюзы виртуальных сетей хранятся в одной подсети.

- **Виртуальные сети периферийных зон**. Периферийные зоны можно использовать для изоляции рабочих нагрузок в их виртуальных сетях, управляемых отдельно от других периферийных зон. Каждая рабочая нагрузка может содержать несколько уровней с несколькими подсетями, подключенными через подсистемы балансировки нагрузки Azure. 

- **Пиринговая связь между виртуальными сетями**. Две виртуальные сети можно подключить между собой с помощью пирингового подключения. Пиринговые подключения представляют собой нетранзитивные подключения между виртуальными подсетями с низкой задержкой. После установки пирингового подключения виртуальные сети обмениваются трафиком по магистрали Azure без необходимости использования маршрутизатора. В звездообразной топологии сети пиринг виртуальной сети используется для подключения концентратора к каждой периферийной зоне. Пиринг можно создать между виртуальными сетями в одном или в разных регионах.

## <a name="create-the-directory-structure"></a>Создание структуры каталога

Создайте каталог, содержащий файлы конфигурации Terraform для демонстрации.

1. Перейдите на [портал Azure](https://portal.azure.com).

1. Откройте [Azure Cloud Shell](/azure/cloud-shell/overview). Если ранее среда не была выбрана, то в качестве среды необходимо выбрать **Bash**.

    ![Командная строка Cloud Shell](./media/common/azure-portal-cloud-shell-button-min.png)

1. Перейдите в каталог `clouddrive`.

    ```bash
    cd clouddrive
    ```

1. Создайте каталог с именем `hub-spoke`.

    ```bash
    mkdir hub-spoke
    ```

1. Перейдите в новый каталог:

    ```bash
    cd hub-spoke
    ```

## <a name="declare-the-azure-provider"></a>Объявление поставщика Azure

Создайте файл конфигурации Terraform, который объявляет поставщик Azure.

1. В Cloud Shell откройте новый файл с именем `main.tf`.

    ```bash
    code main.tf
    ```

1. Скопируйте приведенный ниже код и вставьте его в редактор.

    ```hcl
    provider "azurerm" {
        version = "~>1.22"
    }
    ```

1. Сохраните файл и закройте редактор.

## <a name="create-the-variables-file"></a>Создание файла переменных

Создайте файл конфигурации Terraform для общих переменных, используемых в различных скриптах.

1. В Cloud Shell откройте новый файл с именем `variables.tf`.

    ```bash
    code variables.tf
    ```

1. Скопируйте приведенный ниже код и вставьте его в редактор.

    ```hcl
    variable "location" {
      description = "Location of the network"
      default     = "centralus"
    }
    
    variable "username" {
      description = "Username for Virtual Machines"
      default     = "testadmin"
    }
    
    variable "password" {
      description = "Password for Virtual Machines"
      default     = "Password1234!"
    }
    
    variable "vmsize" {
      description = "Size of the VMs"
      default     = "Standard_DS1_v2"
    }
    ```

1. Сохраните файл и закройте редактор.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"] 
> [Создание локальной виртуальной сети с помощью Terraform в Azure](./hub-spoke-on-prem.md)