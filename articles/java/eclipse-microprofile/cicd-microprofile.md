---
title: Реализация CI/CD для приложений MicroProfile с помощью Azure Pipelines
description: Узнайте, как настроить цикл выпуска CI/CD для развертывания приложений MicroProfile в экземпляре Веб-приложения для контейнеров Azure с помощью Azure Pipelines.
services: devops
documentationcenter: MicroProfile
author: ruyakubu
manager: brunoborges
ms.author: ruyakubu
ms.date: 07/31/2019
ms.tgt_pltfrm: multiple
ms.topic: tutorial
ms.workload: web
ms.openlocfilehash: cdd704626b51105f93c19378511f4a267cb56649
ms.sourcegitcommit: 0af39ee9ff27c37ceeeb28ea9d51e32995989591
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81670300"
---
# <a name="cicd-for-microprofile-apps-using-azure-pipelines"></a>Реализация CI/CD для приложений MicroProfile с помощью Azure Pipelines

В этом руководстве показано, как без усилий настроить цикл выпуска непрерывной интеграции и непрерывного развертывания (CI/CD) Azure Pipelines, чтобы развернуть приложение Java EE [MicroProfile](http://microprofile.io) в Веб-приложение для контейнеров Azure. Приложение MicroProfile использует базовый образ [Payara Micro](https://www.payara.fish/payara_micro) для создания WAR-файла. 

```Dockerfile
FROM payara/micro:5.182
COPY target/*.war $DEPLOY_DIR/ROOT.war
EXPOSE 8080
```
Мы начнем процесс контейнеризации в Azure Pipelines с создания образа Docker, а затем отправим образ контейнера в Реестр контейнеров Azure (ACR). В конце мы создадим конвейер выпуска Azure Pipelines и развернем образ контейнера в веб-приложение.

## <a name="prerequisites"></a>Предварительные требования

1. На [портале Azure](https://portal.azure.com) создайте [реестр контейнеров Azure](https://azure.microsoft.com/services/container-registry).
   
1. На портале Azure создайте [веб-приложение для контейнеров Azure](https://azure.microsoft.com/services/app-service/containers/). Для параметра **ОС** выберите **Linux**, а для параметра **Настройка контейнера** выберите **Быстрый запуск** в качестве **источника образа**.  
   
1. Скопируйте и сохраните URL-адрес клона из этого примера репозитория на GitHub: [https://github.com/Azure-Samples/microprofile-hello-azure](https://github.com/Azure-Samples/microprofile-hello-azure).
   
1. Зарегистрируйтесь или войдите в [Azure DevOps](https://dev.azure.com) организации и создайте [проект](/vsts/organizations/projects/create-project). 
   
1. Импортируйте пример репозитория GitHub в Azure Repos:
   
   1. На странице проекта Azure DevOps в области навигации слева выберите **Репозитории**.
   1. В разделе **или импортировать репозиторий** щелкните **Импорт**. 
   1. В разделе **URL-адрес клона** введите сохраненный URL-адрес клона Git и щелкните **Импорт**.
  
## <a name="create-a-build-pipeline"></a>Создание конвейера сборки

Конвейер сборки непрерывной интеграции в Azure Pipelines автоматически выполняет все задачи сборки при каждой фиксации в исходном приложении Java EE. В этом примере для сборки проекта Java MicroProfile в Azure Pipelines используется Maven.

1. На странице проекта Azure DevOps в области навигации слева выберите **Конвейеры** > **Сборки**. 
   
1. Выберите **Новый конвейер**.
   
1. Выберите **Использовать классический редактор для создания конвейера без YAML**. 
   
1. Убедитесь, что имя проекта и импортированный репозиторий GitHub отображаются в соответствующих полях, и щелкните **Продолжить**.
   
1. Выберите **Maven** в списке шаблонов и щелкните **Применить**.
   
1. Убедитесь, что в области справа в раскрывающемся списке **Пул агентов** отображается **Размещение в Ubuntu 1604**.
   
   > [!NOTE]
   > Так вы определите, какой сервер сборки будет использоваться в Azure Pipelines.  Вы также можете использовать закрытый пользовательский сервер сборки.
   
1. Чтобы настроить конвейер для непрерывной интеграции, перейдите на вкладку **Триггеры** в области слева и установите флажок **Включить непрерывную интеграцию**.  
   
1. В верхней части страницы откройте раскрывающийся список рядом с пунктом **Сохранить и поместить в очередь**, а затем щелкните **Сохранить**. 

   ![Включение непрерывной интеграции](media/cicd-microprofile/continuous-integration.png)

## <a name="create-a-docker-build-image"></a>Создание образа сборки Docker

Для создания образа Docker в Azure Pipelines используется файл Docker с базовым образом из Payara Micro.  

1. Перейдите на вкладку **Задачи** и щелкните знак плюса **+** рядом с пунктом **Задание агента 1**, чтобы добавить задачу.
   
   ![Добавление новой задачи](media/cicd-microprofile/add-task.png)
   
1. В области справа выберите **Docker** в списке шаблонов и щелкните **Добавить**. 
   
1. В области слева выберите **buildAndPush**, а в области справа введите описание в поле **Отображаемое имя**.
   
1. В разделе **Репозиторий контейнеров** выберите **Создать** рядом с полем **Реестр контейнеров**. 
   
1. Укажите в диалоговом окне **Добавить подключение службы для реестра Docker** следующие сведения:
   
   |Поле|Значение|
   |---|---|
   |**Тип реестра**|Выберите **Реестр контейнеров Azure**.|
   |**Имя соединения**|Введите имя для подключения.|
   |**Подписка Azure.**|Выберите подписку Azure в раскрывающемся списке и при необходимости щелкните **Авторизовать**.|
   |**Реестр контейнеров Azure**|Выберите нужное имя Реестра контейнеров Azure в раскрывающемся списке.| 
   
1. Щелкните **ОК**.
   
   ![Добавление подключения службы для реестра Docker](media/cicd-microprofile/dockerconnection.png)
   
   > [!NOTE]
   > Если вы используете Docker Hub или другой реестр, выберите **Docker Hub** или **Другое** вместо **Реестр контейнеров Azure** рядом с пунктом **Тип реестра**. Затем укажите учетные данные и сведения о подключении для этого реестра.
   
1. В разделе **Команды** выберите **выполнить сборку** в раскрывающемся списке **Команды**.
   
1. Нажмите кнопку с многоточием **...** рядом с полем **Dockerfile**, найдите и выберите **Dockerfile** в репозитории GitHub, а затем щелкните **ОК**. 
   
   ![Выбор Dockerfile](media/cicd-microprofile/selectdockerfile.png)
   
1. В разделе **Теги** введите *последнее* в новой строке. 
   
1. В верхней части страницы откройте раскрывающийся список рядом с пунктом **Сохранить и поместить в очередь**, а затем щелкните **Сохранить**. 

## <a name="push-the-docker-image-to-acr"></a>Отправка образа Docker в ACR

Azure Pipelines отправляет образ Docker в Реестр контейнеров Azure и использует его для запуска приложения API MicroProfile в контейнерном веб-приложении Java.

1. Так как вы используете Docker в Azure Pipelines, создайте другой шаблон Docker (см. раздел [Создание образа сборки Docker](#create-a-docker-build-image) выше). В раскрывающемся меню **Команда** выберите **отправить**.
   
1. Откройте раскрывающийся список рядом с пунктом **Сохранить и поместить в очередь**, а затем щелкните **Сохранить и поместить в очередь**. 
   
1. Убедитесь, что во всплывающем окне **Запуск конвейера** выбрано **Размещение в Ubuntu 1604** в разделе **Пул агентов**, а затем щелкните **Сохранить и запустить**. 
   
1. После завершения сборки можно щелкнуть гиперссылку на странице**Сборка**, чтобы проверить результат сборки и просмотреть нужные сведения.
   
   ![Выбор гиперссылки](media/cicd-microprofile/checkbuild.png)

## <a name="create-a-release-pipeline"></a>Создание конвейера выпуска

Конвейер непрерывного выпуска Azure Pipelines автоматически активирует развертывание в целевой среде, например Azure, сразу после выполнения сборки. Конвейер выпуска можно создавать для сред разработки и тестирования, а также промежуточной или рабочей среды.

1. На странице проекта Azure DevOps в области навигации слева выберите **Конвейеры** > **Выпуски**. 
   
1. Выберите **Новый конвейер**.
   
1. В списке шаблонов выберите **Развертывание приложения Java в Службе приложений Azure** и щелкните **Применить**. 
   
   ![Выбор шаблона развертывания приложения Java в Службе приложений Azure](media/cicd-microprofile/selectreleasetemplate.png)
   
1. Во всплывающем окне замените **Этап 1** именем этапа, например: *Разработка*, *Тестирование*, *Подготовка* или *Производство*, а затем закройте окно. 
   
1. В разделе **Артефакты** в области слева выберите **Добавить**, чтобы связать артефакты из конвейера сборки с конвейером выпуска. 
   
1. В области справа выберите конвейер сборки в раскрывающемся списке в разделе **Источник (конвейер сборки)** и щелкните **Добавить**.
   
   ![Добавление артефакта сборки](media/cicd-microprofile/addbuildartifact.png)
   
1. Щелкните гиперссылку в этапе **Производство** и выберите **Просмотреть задачи этапа**.
   
   ![Выбор этапа выпуска](media/cicd-microprofile/viewstagetasks.png)
   
1. В области справа заполните форму следующим образом:
   
   |Поле|Значение|
   |---|---|
   |**Подписка Azure.**|Выберите подписку Azure в раскрывающемся списке.|
   |**Тип приложения**|Выберите **Веб-приложение для контейнеров (Linux)** в раскрывающемся списке.|
   |**Имя службы приложений**|Выберите экземпляр ACR в раскрывающемся списке.|
   |**Реестр или пространство имен**|Введите имя ACR в поле. Например, введите *mymicroprofileregistry.azure.io*.
   |**Репозиторий**|Укажите репозиторий, содержащий образ Docker.| 
   
   ![Настройка задач этапа](media/cicd-microprofile/configurestage.png)
   
1. В области слева выберите **Развернуть WAR-файл в Службе приложений Azure**, а в области справа введите тег *последнее* в поле **Тег**. 
   
1. В области слева выберите **Запустить в агенте**, а в области справа выберите **Размещение в Ubuntu 1604** в раскрывающемся списке **Пул агентов**. 

## <a name="set-up-environment-variables"></a>Настройка переменных среды

Добавьте и определите переменные среды для подключения к реестру контейнеров во время развертывания.

1. Перейдите на вкладку **Переменные** и щелкните **Добавить**, чтобы добавить следующие переменные для URL-адреса реестра контейнеров, имени пользователя и пароля. 
   
   |Имя|Значение|
   |---|---|
   |*registry.url*|Введите URL-адрес реестра контейнеров. Например: *https:\//mymicroprofileregistry.azure.io*|
   |*registry.username*|Введите имя пользователя для реестра.|
   |*registry.password*|Введите пароль для реестра. В целях безопасности щелкните значок замка, чтобы скрыть значение пароля.|
   
   ![Добавление переменных](media/cicd-microprofile/addvariables.png)
   
1. На вкладке **Задачи** выберите **Развернуть WAR-файл в Службе приложений Azure** в области слева. 
   
1. В области справа разверните узел **Параметры приложения и конфигурации**, а затем нажмите кнопку с многоточием **...** рядом с полем **Параметры** приложения.
   
1. Во всплывающем окне **Параметры приложения** выберите **Добавить**, чтобы определить и назначить переменные параметров приложения:
   
   |Имя|Значение|
   |---|---|
   |*DOCKER_REGISTRY_SERVER_URL*|*$(registry.url)*|
   |*DOCKER_REGISTRY_SERVER_USERNAME*|*$(registry.username)*|
   |*DOCKER_REGISTRY_SERVER_PASSWORD*|*$(registry.password)*|
   
1. Щелкните **ОК**.
   
   ![Добавление и настройка переменных](media/cicd-microprofile/appsettings.png)
   
## <a name="set-up-continuous-deployment"></a>Непрерывное развертывание с использованием GIT в службе приложений Azure 

Чтобы включить непрерывное развертывание, сделайте следующее: 

1. На вкладке **Конвейер** в разделе **Артефакты** щелкните значок с молнией в артефакте сборки. 
   
1. В области справа задайте для параметра **Триггер непрерывного развертывания** значение **Включено**.
   
1. Щелкните **Сохранить** вверху справа, а затем еще раз щелкните **Сохранить**. 
   
   ![Включение триггера непрерывного развертывания](media/cicd-microprofile/setcontinuousdeployment.png)
   
## <a name="deploy-the-java-app"></a>Развертывание приложения Java

Теперь, когда вы включили CI/CD, измененный исходный код создаст и запустит сборки и выпуски автоматически. Вы также можете создавать и запускать выпуски вручную следующим образом:

1. На странице конвейера выпуска вверху справа щелкните **Создать выпуск**.
   
1. На странице **Создание выпуска** выберите имя стадии в разделе **Стадии для изменения активации с автоматической на ручную**. 
   
1. Нажмите кнопку **создания**. 
   
1. Выберите имя выпуска, наведите указатель на этап или выберите его, а затем щелкните **Развернуть**. 
   
## <a name="test-the-java-web-app"></a>Тестирование веб-приложения Java

После успешного развертывания протестируйте приложение. 

1. Скопируйте URL-адрес веб-приложения с портала Azure.
   
   ![Приложение Службы приложений на портале Azure](media/cicd-microprofile/portalurl.png)
   
1. Введите URL-адрес в браузере, чтобы запустить приложение. На веб-странице должно отобразится **Hello Azure!**
   
   ![Страница веб-приложения Java](media/cicd-microprofile/webapp.png)

